import { mkdir, readFile, writeFile } from "node:fs/promises";
import { dirname, resolve } from "node:path";
import { fileURLToPath } from "node:url";
import { timeZonesNames } from "@vvo/tzdb";

const scriptDir = dirname(fileURLToPath(import.meta.url));
const repoRoot = resolve(scriptDir, "..");
const outputPath = resolve(repoRoot, "src/lib/generated/ianaTimezones.ts");
const checkOnly = process.argv.includes("--check");
const compareTimezones = (a, b) => (a === b ? 0 : a < b ? -1 : 1);

function normalizeTimezones() {
  return Array.from(new Set(timeZonesNames.filter((name) => typeof name === "string" && name.length > 0))).sort(compareTimezones);
}

function renderGeneratedFile(zones) {
  const values = zones.map((zone) => `  ${JSON.stringify(zone)},`).join("\n");
  return `// This file is auto-generated by scripts/generate-iana-timezones.mjs.
// Do not edit manually.

export const GENERATED_IANA_TIMEZONES = [
${values}
] as const;

export type GeneratedIanaTimezone = (typeof GENERATED_IANA_TIMEZONES)[number];
`;
}

async function checkContent(nextContent) {
  try {
    const current = await readFile(outputPath, "utf8");
    return current === nextContent;
  } catch {
    return false;
  }
}

async function main() {
  const zones = normalizeTimezones();
  if (zones.length === 0) {
    throw new Error("Timezone generation failed: no zones found from @vvo/tzdb.");
  }

  const nextContent = renderGeneratedFile(zones);
  if (checkOnly) {
    const inSync = await checkContent(nextContent);
    if (!inSync) {
      throw new Error("Generated timezone file is out of date. Run: pnpm generate:iana-timezones");
    }
    return;
  }

  await mkdir(dirname(outputPath), { recursive: true });
  await writeFile(outputPath, nextContent, "utf8");
}

await main();
